# コミュニティ限定デプロイ要件定義

## 前提条件
- コミュニティメンバーは管理者が管理
- 新規メンバーの追加は管理者のみが行う
- メンバーは勝手に他人を招待できない

## アプローチ：シンプルな事前登録制

## 要件定義

### 1. ユーザー管理要件
- 管理者がメールアドレスを事前登録
- 登録されたメールのみアカウント作成可能
- パスワードは各ユーザーが設定
- 複雑な招待システムは不要

### 2. 管理機能要件
- 許可メールアドレスの追加/削除
- ユーザーの利用状況確認
- アカウントの有効/無効切り替え
- CSV一括登録（オプション）

### 3. デプロイ要件
- Render.comでの自動デプロイ
- PostgreSQLデータベース
- 環境変数の安全な管理
- HTTPS自動設定

### 4. 品質保証要件
- 各機能の単体テスト
- 統合テスト
- デプロイ後の動作確認
- エラー時の3回リトライ

## 実装Todo一覧

### 高優先度タスク
1. データベース拡張 - allowed_emailsテーブル作成（email, created_at, is_active）
2. 登録API改修 - allowed_emailsチェック機能追加
3. 管理者API作成 - メールアドレス追加/削除/一覧取得
4. 管理画面UI作成 - 許可メール管理、ユーザー一覧表示
10. ローカル動作テスト - 全機能の正常動作確認（3回リトライ）
11. デプロイ前チェック - 環境変数、データベース接続、ビルド確認
12. Renderデプロイ実行 - GitHub連携、自動デプロイ設定
13. 本番環境テスト - 登録、ログイン、レポート作成（3回リトライ）
15. 最終動作確認とエラー報告書作成 - 未解決問題のまとめ

### 中優先度タスク
5. PostgreSQL対応 - SQLAlchemyの設定変更、マイグレーション
6. 環境変数整理 - 本番用SECRET_KEY、DATABASE_URL設定
7. Render設定ファイル作成 - render.yaml、ビルド設定
8. 単体テスト実装 - 許可メール検証、管理API、登録フロー
9. 統合テスト実装 - 登録から利用までの一連フロー

### 低優先度タスク
14. 管理者向けドキュメント作成 - メンバー追加手順、トラブルシューティング

## テスト戦略

### Phase 1: 機能開発時
- 許可メール検証の単体テスト
- API エンドポイントのテスト
- フロントエンドの動作確認

### Phase 2: 統合時
- 新規登録フロー全体
- 管理機能の一連操作
- エラーハンドリング

### Phase 3: デプロイ時
- ローカル環境での完全動作確認
- ステージング環境でのテスト
- 本番環境での最終確認

### エラー対応ルール
- 各テストで失敗した場合、3回まで修正を試みる
- 3回失敗したら「未解決」として記録
- 最終報告書にまとめて報告

## 実装スケジュール

1. **基盤整備（2-3日）**
   - データベース拡張
   - 基本的なAPI実装
   - 認証フローの改修

2. **機能実装（2-3日）**
   - 管理画面の構築
   - テストの作成
   - ローカルでの動作確認

3. **デプロイ準備（1-2日）**
   - PostgreSQL対応
   - 環境設定
   - Render設定

4. **本番デプロイ（1日）**
   - デプロイ実行
   - 動作確認
   - ドキュメント作成

## 技術スタック
- バックエンド: FastAPI + PostgreSQL
- フロントエンド: React + TypeScript
- デプロイ: Render.com
- 認証: JWT + ホワイトリスト方式