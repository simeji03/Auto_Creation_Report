"""
テストデータ生成API - 認証無効版（詳細版）
新フォーマットの月報を生成
"""
from fastapi import APIRouter, Depends, Header
from sqlalchemy.orm import Session
from datetime import datetime
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from utils.date_utils import get_report_month

from database import get_db, MonthlyReport
from schemas import MonthlyReportCreate
from typing import Optional

router = APIRouter()

# 固定ユーザーID（認証無効化のため）
DEMO_USER_ID = 3

@router.post("/generate-test-report")
async def generate_test_report(
    db: Session = Depends(get_db),
    x_openai_api_key: Optional[str] = Header(None)
):
    """
    テストデータで月報を即座に作成（認証無効版・新フォーマット）
    """
    # 15日基準で月報の月を決定
    test_month = get_report_month()
    
    # 新フォーマットの月報コンテンツを生成
    year, month = test_month.split('-')
    year_month = f"{year}年{int(month)}月"
    
    # AIキーがある場合は詳細版、ない場合は標準版
    if x_openai_api_key or os.getenv("OPENAI_API_KEY"):
        ai_generated_report = f"""# {year_month} 月報

お疲れ様です。{year_month}の月報をお送りします。

## 📊 今月の実績概要

| 項目 | 実績 | 備考 |
|------|------|------|
| 稼働時間 | 180時間 | 案件作業150時間、営業20時間、学習10時間 |
| 収入 | 75万円 | 目標達成率: 150% (目標50万円) |
| 営業活動 | 50件 | 送信50件、返信15件、面談8件 |

## 🎯 目標達成状況

**今月の目標:** 営業50件送信、案件3件納品、ポモ部屋100時間参加

**達成状況:** 営業は目標通り50件送信でき、返信率も30%と好調でした。案件は4件納品と目標を上回り、ポモ部屋も120時間参加できました。特に新規クライアントから高評価をいただき、継続案件につながったのが大きな成果です。

## 💼 業務内容・取り組み

### 主な案件・プロジェクト
- ECサイトのLP制作（5万円）: Next.js + Tailwind CSSで実装。レスポンシブ対応も含めて2日で納品
- 企業サイトの修正案件（3万円）: WordPressのカスタマイズ。PHPの知識が活かせた
- 新規Webアプリ開発（20万円）: React + TypeScriptで管理画面を構築。1週間のスプリントで完成
- 継続案件のメンテナンス（10万円×2）: 既存クライアント2社の定期メンテナンス

### 営業・マーケティング活動
新規営業50件送信し、15件の返信（返信率30%）を獲得。そのうち8件が面談に進み、3件が成約。特にTwitter経由での問い合わせが増えており、SNSマーケティングの効果を実感しています。ポートフォリオサイトのアクセス数も前月比150%増加。

### 学習・スキルアップ
- AIツール（GitHub Copilot）の導入により、コーディング速度が約30%向上
- ポモ部屋での情報交換から、新しいフレームワーク（Astro）について学習開始
- Udemy講座「実践的なTypeScript」を完走し、型安全なコーディングスキルが向上

## 🏠 生活・家庭の状況

今月は子どもの学校行事が多く、参観日や運動会の準備で忙しい月でした。ただ、在宅ワークの利点を活かして、すべての行事に参加できたのは良かったです。

夫の仕事も忙しく、ワンオペになる日が週3日ほどありましたが、朝の時間を有効活用することで、家事と仕事のバランスを保つことができました。特に朝5時起きの習慣が定着し、集中できる時間が確保できています。

## 💡 今月の気づき・学び

### 良かったこと・成長ポイント
- **営業メールの返信率が30%**と過去最高を記録。テンプレートの改善と個別カスタマイズの効果
- **AIツールの活用**により、単純作業が減り、クリエイティブな部分に集中できるようになった
- **朝型生活の定着**で、1日の生産性が大幅に向上。朝の2時間は夜の4時間に匹敵
- **初めて月収75万円を達成**し、目標の50万円を大きく上回った

### 課題・改善点
- **営業活動の時間配分**が課題。成約率は高いが、送信数をもっと増やせば収入アップが見込める
- **新技術の学習時間**が不足。もっと計画的に学習時間を確保する必要がある
- **体調管理**がおろそかになりがち。運動時間の確保が必要

## 🚀 来月の目標・計画

### 重点取り組み項目
- **営業活動を100件/月**に倍増し、新規クライアント獲得を加速
- **単価アップ交渉**を既存クライアント3社と実施
- **新サービス（Webサイト高速化診断）**の立ち上げ
- **外注パートナー**を1名確保し、案件対応力を強化

### 新しく始めること
- 営業自動化ツールの導入検討
- ブログでの技術情報発信（週1記事）
- オンラインコミュニティでの登壇（月1回）

### やめること・減らすこと
- 深夜作業を完全に廃止（健康優先）
- 単価の低い修正案件は徐々に減らす
- 無駄な会議や打ち合わせは最小限に

---

以上、{year_month}の活動報告でした。来月もよろしくお願いいたします！"""
    else:
        # 標準版（APIキーなし）
        ai_generated_report = f"""# {year_month} 月報

お疲れ様です。{year_month}の月報をお送りします。

## 📊 今月の実績概要

| 項目 | 実績 | 備考 |
|------|------|------|
| 稼働時間 | 160時間 | 案件作業中心の活動 |
| 収入 | 75万円 | 目標達成 |
| 営業活動 | 50件 | 新規開拓への取り組み |

## 🎯 目標達成状況

**今月の目標:** 営業50件送信、案件3件納品、安定収入の確保

**達成状況:** 計画通りに業務を遂行し、目標を達成することができました。

## 💼 業務内容・取り組み

### 主な案件・プロジェクト
今月は複数のWeb制作案件に携わり、クライアントの要望に応えることができました。技術的な課題も適切に解決し、品質の高い成果物を納品しました。

### 営業・マーケティング活動
新規営業活動を積極的に行い、複数の見込み客を獲得。今後の案件につながる関係構築ができました。

### 学習・スキルアップ
新しい技術やツールについて学習し、実務に活用できるスキルを身につけました。

## 🏠 生活・家庭の状況

家庭と仕事のバランスを保ちながら、充実した1ヶ月を過ごすことができました。家族との時間も大切にしつつ、仕事にも集中できる環境を維持しています。

## 💡 今月の気づき・学び

### 良かったこと・成長ポイント
- 効率的な作業方法を確立できた
- 新規クライアントとの良好な関係を構築
- 収入目標を達成

### 課題・改善点
- 時間管理のさらなる最適化が必要
- 新技術の習得にもっと時間を割きたい

## 🚀 来月の目標・計画

### 重点取り組み項目
- 営業活動の強化
- 既存クライアントとの関係深化
- 新サービスの検討

### やめること・減らすこと
- 非効率な作業の見直し
- 優先順位の低いタスクの整理

---

以上、{year_month}の活動報告でした。来月もよろしくお願いいたします！"""
    
    # 新規月報作成
    new_report = MonthlyReport(
        user_id=DEMO_USER_ID,
        report_month=test_month,
        current_phase="フリーランスエンジニアとして在宅で働きながら、家族との時間も大切にして月40万円の安定収入を得たいです。",
        family_status="子どもの学校行事が多く、在宅ワークの利点を活かして参加できました。",
        total_work_hours=180.0 if x_openai_api_key else 160.0,
        coding_hours=150.0 if x_openai_api_key else 120.0,
        meeting_hours=0.0,
        sales_hours=20.0,
        sales_emails_sent=50,
        sales_replies=15,
        sales_meetings=8,
        contracts_signed=3,
        received_amount=750000.0,
        delivered_amount=750000.0,
        good_points=ai_generated_report,  # 新フォーマットの全文をここに保存
        challenges="営業活動の時間配分が課題。新技術の学習時間が不足。",
        improvements="",
        next_month_goals="営業活動を100件/月に倍増。単価アップ交渉を実施。"
    )
    
    db.add(new_report)
    db.commit()
    db.refresh(new_report)
    
    return {
        "message": "テストデータで月報が作成されました",
        "report_id": new_report.id,
        "report_month": new_report.report_month,
        "ai_generated_content": ai_generated_report  # AI生成コンテンツを返す
    }