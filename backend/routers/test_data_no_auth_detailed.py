"""
テストデータ生成API - 認証無効版（詳細版）
新フォーマットの月報を生成
"""
from fastapi import APIRouter, Depends, Header
from sqlalchemy.orm import Session
from datetime import datetime
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from utils.date_utils import get_report_month

from database import get_db, MonthlyReport
from schemas import MonthlyReportCreate
from typing import Optional

router = APIRouter()

# 固定ユーザーID（認証無効化のため）
DEMO_USER_ID = 3

@router.post("/generate-test-report")
async def generate_test_report(
    db: Session = Depends(get_db),
    x_openai_api_key: Optional[str] = Header(None)
):
    """
    テストデータで月報を即座に作成（認証無効版・新フォーマット）
    """
    # 15日基準で月報の月を決定
    test_month = get_report_month()
    
    # 新フォーマットの月報コンテンツを生成
    year, month = test_month.split('-')
    year_month = f"{year}年{int(month)}月"
    
    # AIキーがある場合は詳細版、ない場合は標準版
    if x_openai_api_key or os.getenv("OPENAI_API_KEY"):
        # OpenAI APIを使用して月報を生成
        try:
            from openai import OpenAI
            client = OpenAI(api_key=x_openai_api_key or os.getenv("OPENAI_API_KEY"))
            
            prompt = f"""
あなたは優秀な月報作成アシスタントです。以下の質問と回答から、{year_month}の月報を生成してください。

【重要な指示】
- 対象月は{year_month}です
- タイトルには必ず「# 月報：{year_month}」を使用
- 2025年06月や他の年月は絶対に使用しない
- 現在日時に関係なく、指定された{year_month}の月報として作成

## 回答データ:
【目指しているゴール・理想の生活】
理想の暮らし・働き方: 週4日勤務で月収50万円を維持しながら、子どもの送迎ができる生活。在宅メインで好きな仕事だけで生計を立てたい。
普段大事にしていること: 相手目線で動く、夜9時以降は仕事しない、毎朝必ずスケジュール確認、家族との時間を最優先にする。
理想の未来像: 朝はカフェでゆったり仕事、午後は子どもと公園、週末は家族でキャンプ。年1回は海外旅行。AI活用で効率化し、クリエイティブな仕事に集中。

【今月の目標と実績】
今月の目標: 営業メール50件送信、LP案件3件納品、ポモ部屋100時間参加、新規クライアント2社獲得、月収35万円達成
目標達成状況: 営業は50件送信で達成（100%）、LP案件は4件納品（133%）、ポモ部屋は120時間（120%）、新規クライアント3社獲得、月収は75万円で目標の214%

【今月の業務内容・取り組み・学び】
今月やったこと: LPコーディング4件（各15-20万円）、修正案件5件（計10万円）、営業メール50件送信、AIツール勉強会3回参加、ポモ部屋120時間、ブログ記事8本執筆
案件で印象に残ったこと: 初めて20万円の大型LP案件を受注・完成。TypeScriptとNext.jsを使った最新技術での実装。クライアントから「期待を大幅に超えた」と最高評価。
営業活動と反応: 新規50件送信で返信15件（返信率30%）、うち8件面談実施。既存クライアント5社から追加案件の相談。来月の案件パイプラインが過去最高に充実。
学びで良かったこと: GitHub Copilotの活用方法を完全マスター、TypeScriptの型安全性を実感、ポモ部屋でAstroフレームワークを習得、効率化により作業時間を30%短縮できた

【稼働時間・収入】
稼働時間: 合計180時間。内訳：案件作業150時間、営業活動20時間、学習・スキルアップ10時間。先月より20時間減少したが収入は増加。
収入: 合計75万円。LP案件4件で65万円、修正案件で10万円。来月は受注済み案件で80万円見込み。

【今月の状況・家庭のこと】
家庭や生活の変化: 子どもの運動会と参観日があり忙しかった、夫の仕事が繁忙期でワンオペ増、実家の両親が元気で安心、健康診断の結果も良好
生活バランス: 案件は多かったが効率化で家族時間を確保。朝5時起きが完全に定着。理想の7:3バランスに近づいた。夜の作業を完全にやめられた。
役割: 家庭では朝食と送迎の完全担当、仕事では4つのプロジェクトでリード、コミュニティでは新人メンターとして3名をサポート、実家のIT全般サポート

【課題・改善点・気づき・成果】
大変だったこと・困ったこと: 案件が重なって一時的にキャパオーバー、営業メールの返信対応に時間がかかった、新技術の学習時間の確保が難しかった
気づいたこと・改善点: 外注パートナーの必要性を痛感、営業の自動化ツール導入を検討、朝の2時間は夜の4時間分の価値、断る勇気も必要
成長したこと: TypeScriptでの開発速度が3倍に向上、営業メールの成約率が過去最高、クライアント満足度が大幅向上、外注管理スキルが身についた
嬉しかったこと: 初の月収75万円達成、クライアントから紹介をいただいた、子どもに「ママすごい」と言われた、ポモ部屋で表彰された、夫が家事を積極的に手伝ってくれるようになった

【来月の目標・取り組み予定】
来月の目標: 営業100件送信は必達、受注済み案件5件の確実な納品、ポモ部屋150時間、家族時間を週25時間確保、月収80万円を目指す
やらないと決めたこと: 深夜作業は完全禁止、5万円以下の単発案件は受けない、無駄な打ち合わせは断る、完璧主義をやめて8割で進める

## 出力要件:
- 対象月: {year_month} (厳守)
- 文字数: 基本は2000-3000文字
- 形式: Markdown（Notion互換）
- 語調: 丁寧で親しみやすい
- 絵文字: 見出しの先頭に1つずつ配置
- 箇条書き: 積極的に使用して読みやすく
- 感情・背景: 事実に基づいて適切に追加

## 必須出力フォーマット（この順序と形式を厳守）:

# 月報：{year_month}

お疲れ様です。{year_month}分の月報を提出します。以下に今月の状況、実績、取り組み、気づき、来月の目標をまとめましたので、ご確認ください。

---

## 🏠 今月の状況・家庭のこと

[家庭や生活での出来事、変化を箇条書きで記載。感情や影響も含める]

---

## 🎯 目指しているゴール・理想の生活

[理想の暮らし・働き方・価値観を箇条書きで記載]

---

## 📊 今月の目標と実績

[まず今月の目標と達成状況を文章で記載]

| 項目 | 実績 | 補足 |
| --- | --- | --- |
| 稼働時間 | [回答から抽出]時間 | 内訳（案件・営業・学び）を含む |
| 営業件数 | [回答から抽出]件 | 新規・継続の内訳、反応状況も含む |
| 受注額 | [回答から抽出]万円 | 案件内容・外注の有無を含む |

---

## 💼 今月の業務内容・取り組み・学び

[業務内容、プロジェクト詳細、営業活動、学習内容をすべて箇条書きで記載]

---

## 💡 課題・改善点・気づき

[課題や困ったこと、気づきを箇条書きで記載。「だから来月は〜する」という改善アクションも含める]

---

## 🌟 今月の成果・成長ポイント

[できたこと、成長したこと、嬉しかったことを箇条書きで記載]

---

## 🚀 来月の目標・取り組み予定

[来月の目標、注力すること、新しく試すこと、やめることを箇条書きで記載]

---

以上となります。来月もどうぞよろしくお願いいたします。
"""
            
            response = client.chat.completions.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": "あなたは優秀な月報作成アシスタントです。"},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=4000,
                temperature=0.7
            )
            
            ai_generated_report = response.choices[0].message.content
            
            # タイトル形式の後処理修正
            if not ai_generated_report.startswith(f"# 月報：{year_month}"):
                # 既存のタイトル行を置換
                ai_generated_report = re.sub(r'^#.*?\n', f'# 月報：{year_month}\n', ai_generated_report, count=1)
            
        except Exception as e:
            print(f"OpenAI API エラー: {e}")
            # エラーの場合はテンプレート版を使用
            ai_generated_report = f"""# 月報：{year_month}

お疲れ様です。{year_month}分の月報を提出します。以下に今月の状況、実績、取り組み、気づき、来月の目標をまとめましたので、ご確認ください。

---

## 🏠 今月の状況・家庭のこと

- 子どもの運動会と参観日があり忙しかったが、在宅ワークの利点を活かして全て参加できた（達成感）
- 夫の仕事が繁忙期でワンオペが週3日ほどあったが、朝の時間を有効活用して対応
- 実家の両親が元気で安心、定期的にビデオ通話で交流
- 健康診断の結果も良好で、健康面での不安がなくなった

**ワークライフバランス**: 案件は多かったが効率化により家族時間を確保。朝5時起きが完全に定着し、理想の7:3バランスに近づいた。夜の作業を完全にやめることができた。

**各領域での役割**:
- 家庭では朝食と送迎の完全担当
- 仕事では4つのプロジェクトでリード
- コミュニティでは新人メンターとして3名をサポート
- 実家のIT全般サポート

---

## 🎯 目指しているゴール・理想の生活

- 週4日勤務で月収50万円を維持しながら、子どもの送迎ができる生活
- 在宅メインで好きな仕事だけで生計を立てる
- 家族との時間を最優先にしつつ、やりがいのある仕事を続ける

**大切にしている価値観**:
- 相手目線で動く
- 夜9時以降は仕事しない
- 毎朝必ずスケジュール確認
- 家族との時間を最優先にする

**理想の未来像**:
- 朝はカフェでゆったり仕事
- 午後は子どもと公園で過ごす
- 週末は家族でキャンプを楽しむ
- 年1回は海外旅行へ
- AI活用で効率化し、クリエイティブな仕事に集中

---

## 📊 今月の目標と実績

**今月の目標**:
- 営業メール50件送信
- LP案件3件納品
- ポモ部屋100時間参加
- 新規クライアント2社獲得
- 月収35万円達成

**達成状況**: 営業は50件送信で達成（100%）、LP案件は4件納品（133%）、ポモ部屋は120時間（120%）、新規クライアント3社獲得、月収は75万円で目標の214%を達成。全ての目標を上回る結果となった。

| 項目 | 実績 | 補足 |
| --- | --- | --- |
| 稼働時間 | **180時間** | 案件作業150時間、営業活動20時間、学習10時間。効率化により先月より20時間減 |
| 営業件数 | **50件** | 送信50件、返信15件（返信率30%）、面談8件、成約3件 |
| 受注額 | **75万円** | LP案件65万円、修正案件10万円。目標達成率214% |

---

## 💼 今月の業務内容・取り組み・学び

**主な活動**:
- ECサイトのLP制作（20万円）: TypeScriptとNext.jsで最新技術を活用
- 企業サイトLP制作3件（各15万円）: デザインから実装まで一貫して担当
- 修正案件5件（計10万円）: 既存クライアントの細かな要望に対応
- 営業メール50件送信: パーソナライズした内容で返信率30%達成
- AIツール勉強会3回参加: 最新のAI開発ツールについて学習
- ポモ部屋120時間: 集中作業と情報交換を実施
- ブログ記事8本執筆: 技術情報の発信を強化

**案件の詳細**:
- 初めて20万円の大型LP案件を受注・完成
- TypeScriptとNext.jsを使った最新技術での実装が高評価
- レスポンシブ対応とアニメーション実装で差別化
- クライアントから「期待を大幅に超えた」と最高評価をいただいた

**営業活動**:
- 新規50件送信で返信15件（返信率30%）
- うち8件が面談に進み、3件が成約
- 既存クライアント5社から追加案件の相談
- 来月の案件パイプラインが過去最高に充実

**学習・スキルアップ**:
- GitHub Copilotの活用方法を完全マスター
- TypeScriptの型安全性を実感し、バグが激減
- ポモ部屋でAstroフレームワークを習得
- 効率化により作業時間を30%短縮できた

---

## 💡 課題・改善点・気づき

**今月の課題**:
- 案件が重なって一時的にキャパオーバー（スケジュール管理の改善が必要）
- 営業メールの返信対応に時間がかかった（テンプレート化を検討）
- 新技術の学習時間の確保が難しかった（計画的な時間配分が必要）

**気づき・改善策**:
- 外注パートナーの必要性を痛感 → 来月は信頼できるパートナーを探す
- 営業の自動化ツール導入を検討 → 効率化で時間を生み出す
- 朝の2時間は夜の4時間分の価値がある → 朝型生活を継続
- 断る勇気も必要 → 選択と集中で質を高める

---

## 🌟 今月の成果・成長ポイント

- TypeScriptでの開発速度が3倍に向上し、品質も大幅改善
- 営業メールの成約率が過去最高を記録（6%→15%）
- クライアント満足度が大幅向上し、紹介案件が増加
- 外注管理スキルが身につき、チームでの仕事が可能に
- 初の月収75万円を達成し、経済的な安定感が増した
- クライアントから紹介をいただき、信頼関係が深まった
- 子どもに「ママすごい」と言われ、仕事への誇りを感じた
- ポモ部屋で月間MVP表彰を受けた
- 夫が家事を積極的に手伝ってくれるようになり、協力体制が強化

---

## 🚀 来月の目標・取り組み予定

**重点目標**:
- 営業100件送信は必達（倍増チャレンジ）
- 受注済み案件5件の確実な納品
- ポモ部屋150時間で更なる生産性向上
- 家族時間を週25時間確保
- 月収80万円を目指す

**新しく始めること**:
- 営業自動化ツールの本格導入
- ブログでの技術情報発信（週1記事）
- オンラインコミュニティでの登壇（月1回）
- 外注パートナーとのチーム体制構築

**やめること・減らすこと**:
- 深夜作業は完全禁止（健康最優先）
- 5万円以下の単発案件は受けない
- 無駄な打ち合わせは断る
- 完璧主義をやめて8割で進める

---

以上となります。来月もどうぞよろしくお願いいたします。"""
        
        # タイトル形式の徎処理修正
        if not ai_generated_report.startswith(f"# 月報：{year_month}"):
            # 既存のタイトル行を置換
            ai_generated_report = re.sub(r'^#.*?\n', f'# 月報：{year_month}\n', ai_generated_report, count=1)
    else:
        # 標準版（APIキーなし）
        ai_generated_report = f"""# 月報：{year_month}

お疲れ様です。{year_month}分の月報を提出します。以下に今月の状況、実績、取り組み、気づき、来月の目標をまとめましたので、ご確認ください。

---

## 🏠 今月の状況・家庭のこと

- 家族との時間を大切にしながら、充実した1ヶ月を過ごすことができた
- 子どもの学校行事に参加し、成長を見守ることができた
- 健康的な生活リズムを維持し、体調も良好
- 在宅ワークの利点を活かして、家庭と仕事のバランスを保った

**ワークライフバランス**: 計画的な時間管理により、仕事と家庭の両立ができた。朝型生活が定着し、効率的な作業が可能になった。

---

## 🎯 目指しているゴール・理想の生活

- 安定した収入を維持しながら、家族との時間を大切にする生活
- 在宅ワークを中心に、自分のペースで仕事を進める
- スキルアップを続けながら、より高度な案件に挑戦していく

**大切にしている価値観**:
- 信頼関係を大切にする
- 品質にこだわる仕事をする
- 継続的な学習と成長を心がける

---

## 📊 今月の目標と実績

**今月の目標**:
- 営業50件送信
- 案件3件納品
- 安定収入の確保
- スキルアップの時間確保

**達成状況**: 計画通りに業務を遂行し、全ての目標を達成することができた。特に営業活動が好調で、来月につながる案件も確保できた。

| 項目 | 実績 | 補足 |
| --- | --- | --- |
| 稼働時間 | **160時間** | 案件作業130時間、営業20時間、学習10時間 |
| 営業件数 | **50件** | 送信50件、返信10件（返信率20%）、面談5件 |
| 受注額 | **75万円** | 目標達成率150% |

---

## 💼 今月の業務内容・取り組み・学び

**主な活動**:
- LP制作案件3件（各20-25万円）を納品
- 既存クライアントのサイト改修2件
- 新規営業メール50件送信
- オンライン勉強会3回参加
- 技術ブログ5記事執筆

**案件の詳細**:
- 最新技術を活用したモダンなWebサイト制作
- レスポンシブ対応とSEO最適化を重視
- クライアントから高評価をいただき、継続案件の相談も

**営業活動**:
- ターゲットを絞った効果的な営業を実施
- 返信率20%と良好な反応
- 5件の面談から2件の成約

**学習・スキルアップ**:
- 新しいフレームワークの習得
- AIツールの活用方法を学習
- 効率化により作業時間を短縮

---

## 💡 課題・改善点・気づき

**今月の課題**:
- 時間管理のさらなる最適化が必要
- 新技術の習得にもっと時間を割きたい
- 営業活動と案件作業のバランス調整

**気づき・改善策**:
- 効率的な作業方法を確立できた → 更なる自動化を検討
- 朝の時間の有効活用が重要 → 朝型生活を継続
- クライアントとの信頼関係が最も重要 → 丁寧な対応を心がける

---

## 🌟 今月の成果・成長ポイント

- 新規クライアントとの良好な関係を構築
- 収入目標を150%達成し、経済的安定を確保
- 新しい技術スキルを習得し、作業効率が向上
- 家族との時間を確保しながら仕事も充実
- クライアントから高評価をいただき、自信につながった

---

## 🚀 来月の目標・取り組み予定

**重点目標**:
- 営業活動を強化し、新規クライアント開拓
- 既存クライアントとの関係を深める
- 月収を安定的に維持
- 家族との時間を確保しつつ、効率的に働く

**新しく始めること**:
- 新サービスの企画検討
- 効率化ツールの導入
- ポートフォリオサイトの更新

**やめること・減らすこと**:
- 非効率な作業の見直し
- 優先順位の低いタスクの整理
- 深夜作業を避ける

---

以上となります。来月もどうぞよろしくお願いいたします。"""
        
        # タイトル形式の徎処理修正
        if not ai_generated_report.startswith(f"# 月報：{year_month}"):
            # 既存のタイトル行を置換
            ai_generated_report = re.sub(r'^#.*?\n', f'# 月報：{year_month}\n', ai_generated_report, count=1)
    
    # 新規月報作成
    new_report = MonthlyReport(
        user_id=DEMO_USER_ID,
        report_month=test_month,
        current_phase="フリーランスエンジニアとして在宅で働きながら、家族との時間も大切にして月40万円の安定収入を得たいです。",
        family_status="子どもの学校行事が多く、在宅ワークの利点を活かして参加できました。",
        total_work_hours=180.0 if x_openai_api_key else 160.0,
        coding_hours=150.0 if x_openai_api_key else 120.0,
        meeting_hours=0.0,
        sales_hours=20.0,
        sales_emails_sent=50,
        sales_replies=15,
        sales_meetings=8,
        contracts_signed=3,
        received_amount=750000.0,
        delivered_amount=750000.0,
        good_points=ai_generated_report,  # 新フォーマットの全文をここに保存
        challenges="営業活動の時間配分が課題。新技術の学習時間が不足。",
        improvements="",
        next_month_goals="営業活動を100件/月に倍増。単価アップ交渉を実施。"
    )
    
    db.add(new_report)
    db.commit()
    db.refresh(new_report)
    
    return {
        "message": "テストデータで月報が作成されました",
        "report_id": new_report.id,
        "report_month": new_report.report_month,
        "ai_generated_content": ai_generated_report  # AI生成コンテンツを返す
    }