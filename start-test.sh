#!/bin/bash
# Тюѕта▒СйюТѕљТћ»ТЈ┤сЃёсЃ╝сЃФ - сЃєсѓ╣сЃѕУхитІЋсѓ╣сѓ»сЃфсЃЌсЃѕ

echo "­Ъџђ Тюѕта▒СйюТѕљТћ»ТЈ┤сЃёсЃ╝сЃФ сЃєсѓ╣сЃѕуњ░тбЃсѓњУхитІЋсЂЌсЂЙсЂЎ"
echo ""

# сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂїТЌбсЂФУхитІЋсЂЌсЂдсЂёсѓІсЂІсЃЂсѓДсЃЃсѓ»
if curl -s http://localhost:8765/health > /dev/null 2>&1; then
    echo "РюЁ сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂ»ТЌбсЂФУхитІЋсЂЌсЂдсЂёсЂЙсЂЎ (http://localhost:8765)"
else
    echo "­ЪћД сЃљсЃЃсѓ»сѓесЃ│сЃЅсѓњУхитІЋсЂЌсЂдсЂёсЂЙсЂЎ..."
    python3 backend/simple_server.py &
    BACKEND_PID=$!

    # УхитІЋсЂЙсЂДтЙЁТЕЪ
    echo "РЈ│ сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂ«УхитІЋсѓњтЙЁТЕЪСИГ..."
    for i in {1..10}; do
        if curl -s http://localhost:8765/health > /dev/null 2>&1; then
            echo "РюЁ сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂїУхитІЋсЂЌсЂЙсЂЌсЂЪ (PID: $BACKEND_PID)"
            break
        fi
        sleep 1
    done
fi

# сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсЂїТЌбсЂФУхитІЋсЂЌсЂдсЂёсѓІсЂІсЃЂсѓДсЃЃсѓ»
if curl -s http://localhost:8080 > /dev/null 2>&1; then
    echo "РюЁ сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсЂ»ТЌбсЂФУхитІЋсЂЌсЂдсЂёсЂЙсЂЎ (http://localhost:8080)"
else
    echo "­Ъїљ сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсѓњУхитІЋсЂЌсЂдсЂёсЂЙсЂЎ..."
    python3 serve-frontend.py &
    FRONTEND_PID=$!

    # УхитІЋсЂЙсЂДтЙЁТЕЪ
    echo "РЈ│ сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсЂ«УхитІЋсѓњтЙЁТЕЪСИГ..."
    for i in {1..10}; do
        if curl -s http://localhost:8080 > /dev/null 2>&1; then
            echo "РюЁ сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсЂїУхитІЋсЂЌсЂЙсЂЌсЂЪ (PID: $FRONTEND_PID)"
            break
        fi
        sleep 1
    done
fi

echo ""
echo "­ЪјЅ сЃєсѓ╣сЃѕуњ░тбЃсЂ«УхитІЋсЂїт«їС║єсЂЌсЂЙсЂЌсЂЪ№╝Ђ"
echo ""
echo "­ЪЊЇ сѓбсѓ»сѓ╗сѓ╣ТЃЁта▒:"
echo "   ­Ъїљ сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅ: http://localhost:8080/test-frontend.html"
echo "   ­ЪћД сЃљсЃЃсѓ»сѓесЃ│сЃЅAPI: http://localhost:8765"
echo "   ­ЪЊІ сЃўсЃФсѓ╣сЃЂсѓДсЃЃсѓ»: http://localhost:8765/health"
echo ""
echo "­ЪДф сЃєсѓ╣сЃѕТЅІжає:"
echo "   1. сЃќсЃЕсѓдсѓХсЂД http://localhost:8080/test-frontend.html сѓњжќІсЂЈ"
echo "   2. 'тЁесЃєсѓ╣сЃѕт«ЪУАї' сЃюсѓ┐сЃ│сѓњсѓ»сЃфсЃЃсѓ»"
echo "   3. тљёТЕЪУЃйсѓњТЅІтІЋсЂДсЃєсѓ╣сЃѕ"
echo ""
echo "­ЪЏЉ тЂюТГбсЂЎсѓІсЂФсЂ» Ctrl+C сѓњТі╝сЂЌсЂдсЂЈсЂасЂЋсЂё"

# сѓисѓ░сЃісЃФсЃЈсЃ│сЃЅсЃфсЃ│сѓ░
trap 'echo ""; echo "­ЪЏЉ сѓхсЃ╝сЃљсЃ╝сѓњтЂюТГбсЂЌсЂдсЂёсЂЙсЂЎ..."; kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; echo "РюЁ сЃєсѓ╣сЃѕуњ░тбЃсЂїтЂюТГбсЂЌсЂЙсЂЌсЂЪ"; exit 0' INT

# сЃЌсЃГсѓ╗сѓ╣сЂїухѓС║єсЂЎсѓІсЂЙсЂДтЙЁТЕЪ
wait